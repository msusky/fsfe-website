<?xml version="1.0" encoding="UTF-8"?>
<html>
  <version>1</version>

<head>
  <title>Search FSFE articles</title>

<script type="text/javascript" src="/scripts/lunr.min.js"></script>
<script src="index.js"></script>
</head>
<body>
<form method="get" action="">
  <input placeholder=" search terms..." id="search" name="q" type="text" aria-label="Search term" />
  <button type="submit" class="button">Search</button>
</form>
<div id="search_results"></div>

<script>
const query = new URLSearchParams(window.location.search);
const searchString = query.get('q');
const locals = [document.documentElement.getAttribute("lang")];
if (!locals.includes('en')) {
    locals.push('en');
}


const $target = document.querySelector('#search_results');
if (searchString) {

// Populate the field with any existing search string
document.querySelector('#search').value = searchString;

// Our index uses title as a key of the hashmap
const pagesByURL = pages.reduce((acc, curr) => {
  acc[curr.url] = curr;
  return acc;
}, {});

index = lunr(function() {
                    this.field("title", { boost: 10 });
                    this.field("tags", { boost: 5 });
                    this.field("teaser",);
                    this.ref("url");

                    pages.forEach(function (page) {
                        this.add(page)
                    }, this)
                });

  // Do the search and filter out results not from the current local or English
  const matches = index.search(searchString).filter(p => locals.some(local => p.ref.includes(local)));

  if (matches.length > 0) {
    $target.innerHTML = matches.slice(0, 15).map(p => {
        title = pagesByURL[p.ref].title;
        return '<li><a href='&apos;+p.ref+&apos;'>' + title + ' </a></li>';
    }).join('');
  } else {
    $target.innerHTML = `<div>No search results found. Please rephrase your query</div>`;
  }
} else {
    $target.innerHTML = `<div>No search results found. Please rephrase your query</div>`;
}
</script>
</body>
</html>
